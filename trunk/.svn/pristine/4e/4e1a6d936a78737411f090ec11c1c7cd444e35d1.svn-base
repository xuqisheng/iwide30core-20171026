<?php
/**
* 酒店提醒
* author chenjunyu 2016-10-19
*/

defined ( 'BASEPATH' ) or exit ( 'No direct script access allowed' );
header("Content-type:text/html;charset=utf-8");

class Hotel_notify extends MY_Front{

	function __construct(){
		parent::__construct();
		$this->inter_id=$this->session->userdata('inter_id');
		$this->openid=$this->session->userdata($this->inter_id.'openid');
		MYLOG::hotel_tracker($this->openid,  $this->inter_id);
		$this->datas['inter_id'] = $this->inter_id;
		if($this->input->get('asd')){
			$this->output->enable_profiler(true);
		}
	}

	public function index(){
		
	}

	public function register(){
		$data = array();
		$this->load->model('hotel/hotel_notify_model');
		//查询该用户的绑定情况和状态
		$reg_info = $this->hotel_notify_model->get_config($this->openid,$this->inter_id);
		if($reg_info){
			redirect(site_url('hotel_notify/hotel_notify/result').'?id='.$this->inter_id);
		}else{
			//查出当前酒店内部id下的所有酒店信息
			$data['hotels'] = $this->hotel_notify_model->get_all_hotels($this->inter_id);
			//压入全部酒店选项
			array_unshift($data['hotels'], array('hotel_id'=>0,'inter_id'=>$this->inter_id,'name'=>'全部酒店'));
			$this->display('hotel_notify/register',$data);
		}
	}

	//异步注册请求
	public function toRegister(){
		$this->load->model('hotel/hotel_notify_model');
		if($errmsg = $this->hotel_notify_model->save()){
			echo json_encode($errmsg);
		}else{
			echo json_encode($errmsg);
		}
	}


	function result(){
		$this->load->model ( 'hotel/hotel_notify_model' );
		$reg_info = $this->hotel_notify_model->get_config ( $this->openid, $this->inter_id );
		if(!$reg_info){
			redirect(site_url('hotel_notify/hotel_notify/register').'?id='.$this->inter_id);
		}else{
			$datas ['status'] = $reg_info['status']==1?'complete':'unbind';
			if($reg_info['hotel_id']==0){
				$datas ['hotelname'] = '全部酒店';
			}else{
				$this->db->where(array('inter_id'=>$this->inter_id,'hotel_id'=>$reg_info['hotel_id']));
				$hotels = $this->db->get('hotels')->result_array();
				$datas ['hotelname'] = !empty($hotels[0])?$hotels[0]['name']:'';
			}
			$this->display('hotel_notify/register',$datas);
		}
	}
}