<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class Cron_nz extends MY_Controller {

    protected $_basic_path;
    protected $_redis = null;

    public function __construct() {
        parent::__construct();
        $this->_basic_path = APPPATH . '..' . DS . 'www_admin' . DS . 'public' . DS . 'import' . DS;
        $this->_redis = $this->get_redis_instance();
        if($this->_redis == null)
        {
            die('redis connect fail!');
        }
    }

    protected function _parse_csv_file($file) {
        $csv = fopen($file, 'r');
        $csv_data = array(); 
        $n = 0; 
        while ($data = fgetcsv($csv)) { 
            $num = count($data); 
            for ($i = 0; $i < $num; $i++) { 
                $csv_data[$n][$i] = mb_convert_encoding($data[$i], 'utf-8', 'gbk');//$data[$i]; 
            } 
            $n++; 
        }
        return $csv_data;
    }

    protected function get_inter_domain($inter_id)
    {
        $this->load->model('wx/publics_model', 'wxp_model');
        $public = $this->wxp_model->get_public_by_id($inter_id);
        return empty($public['domain']) ? false : $public['domain'];
    }

    protected function get_target_openids_from_csv($inter_id, $file)
    {
        // 抽取需要发送的订单号、openid
        $csv_data = $this->_parse_csv_file($file);
        unset($csv_data[0]);

        $order_ids = $openids = array();
        foreach ( $csv_data as $row)
        {
            if(!empty($row[0]))
            {
                $order_ids[] = $row[0];
            }
            if(!empty($row[1]) && !in_array($row[1], $openids))
            {
                $openids[] = $row[1];
            }
        }

        //初始化数据库分片配置，微信接口关闭订单需要初始化shard_id
        $this->load->model('soma/shard_config_model', 'model_shard_config');
        $this->current_inter_id= $inter_id;
        $this->db_shard_config= $this->model_shard_config->build_shard_config( $inter_id );

        if(!empty($order_ids))
        {
            $this->load->model('soma/Sales_order_model', 'o_model');
            $orders = $this->o_model->get_order_list('package', $inter_id, array('order_id' => $order_ids));
            if(!empty($orders))
            {
                foreach($orders as $order)
                {
                    if(!in_array($order['openid'], $openids))
                    {
                        $openids[] = $order['openid'];
                    }
                }
            }
        }

        return $openids;
    }

    /**
     * Gets the redis instance.
     *
     * @param      string $select The select
     *
     * @return     Redis|null  The redis instance.
     */
    public function get_redis_instance($select = 'soma_redis')
    {
        $this->load->library('Redis_selector');
        if ($redis = $this->redis_selector->get_soma_redis($select)) {
            return $redis;
        }
        return null;
    }

    public function wdm()
    {
        $inter_id = 'a495077577';
        $template_id = 'mAvBTWgcXSs1gmqeyd3bEL0FUZdWOyWECmr7foF0aSg';
        $file = $this->_basic_path . 'wdm.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://mp.weixin.qq.com/s/rzdXvxyLA2AFHRgmPkwg1Q';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '粉丝福利｜您有一份福利待确认',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '电影票、音乐会门票',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '即日起至2017年6月18日22:00',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击详情立即参与活动',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function upsky_gx()
    {
        $inter_id = 'a470377478';
        $template_id = 'DJvbl5nW_Xh18S9b8ugGCqxj2JUsZ4zxu0QUPgJzxQk';
        $file = $this->_basic_path . 'upsky_gx.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.liyewl.com/index.php/soma/package/index/?id=a470377478&tkid=82&catid=';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '亲爱的你，UPSKY广西区年中大促即将开启',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '149元自助晚餐、39.9元双人下午茶、799元2晚商务套房限时抢购',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月15日20:00正式开启',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击本消息立即订阅',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function jt()
    {
        $inter_id = 'a441624001';
        $template_id = 'eyqP2VTvIuf3qh2jniLXrXzaODF3SGtjxjRTuch8HOE';
        $file = $this->_basic_path . 'jt.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://chatinn.iwide.cn/index.php/soma/package/index?id=a441624001';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '您好：街町酒店618已经开启',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '207元起两晚客房券秒杀',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月16日12:00正式开启',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击模版即刻抢购',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function symldm()
    {
        $inter_id = 'a466508403';
        $template_id = 'ZcyMuLi9dFCwI9cxrGfpQXjS3ta5wjqtuqOwBsx0TNE';
        $file = $this->_basic_path . 'symldm.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://symarry.iwide.cn/index.php/soma/package/package_detail?pid=116689&id=a466508403';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '您好：沈阳碧桂园玛丽蒂姆酒店618已经开启',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '618元两晚客房券秒杀、316元买一大一小送一大自助晚餐;',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月16日12:00已经正式开启',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击即刻抢购（分享给好友，购买成功即可获得分销奖励5元）',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function csxld()
    {
        $inter_id = 'a492660851';
        $template_id = 'cC6s1U6bGxhWybVtjxej_jVmYkClL8Rud9kAs7XSacc';
        $file = $this->_basic_path . 'csxld.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.tyxbf.com/index.php/membervip/card/getcard?id=a492660851&card_rule_id=957';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '粉丝福利 | 我们为您预约了一份专属大礼',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '10元商城优惠券（任意正价商品抵用）',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '2017年6月18日-6月23日可用',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击详情立即领取',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function btebg()
    {
        $inter_id = 'a467780350';
        $template_id = '0R1187s4zjDHDsOpUIw8bsDsxziNUdmS8ELKmm1Dbss';
        $file = $this->_basic_path . 'btebg.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.liyewl.com/index.php/soma/package/index?id=a467780350';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '尊敬的顾客，广州白天鹅宾馆618大促已经开启',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '分享秒杀产品，您的好友购买后，您将获得8元奖励',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '秒杀活动将于明日结束，先到先得',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击模版马上分享',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function cdsjc_open()
    {
        $inter_id = 'a484122795';
        $template_id = 'zm7KXr7RKzYuM55TD2OC--mmrLVUQCcnYEF9jVYACJg';
        $file = $this->_basic_path . 'cdsjc.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.iwide.cn/index.php/soma/package/index?id=a484122795';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '成都世纪城天堂洲际大饭店·618父出真爱秒杀即将开启~',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '直降100元自助餐24小时限时抢',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月18日00:00正式开启',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击即刻订阅',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function cdsjc_close()
    {
        $inter_id = 'a484122795';
        $template_id = 'zm7KXr7RKzYuM55TD2OC--mmrLVUQCcnYEF9jVYACJg';
        $file = $this->_basic_path . 'cdsjc.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.iwide.cn/index.php/soma/package/index?id=a484122795';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '成都世纪城天堂洲际大饭店·618父出真爱秒杀火热进行中~',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '直降100元自助餐24小时限时抢',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月18日23:59秒杀关闭',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '赶紧点击抢购',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function cdhq_open()
    {
        $inter_id = 'a484123441';
        $template_id = 'bNfvt9JC8eUP81GjHdaax1g5Pbjmp99CqBzOGkGSpaI';
        $file = $this->_basic_path . 'cdhq.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.iwide.cn/index.php/soma/package/index?id=a484123441';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '成都环球中心洲际天堂大酒店丨微信商城618父亲节福利秒杀火热进行时~',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '感恩父亲节全场五折秒杀限量抢购',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月17日00:00开启中',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击即刻抢购',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

    public function cdhq_close()
    {
        $inter_id = 'a484123441';
        $template_id = 'bNfvt9JC8eUP81GjHdaax1g5Pbjmp99CqBzOGkGSpaI';
        $file = $this->_basic_path . 'cdhq.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://hotels.iwide.cn/index.php/soma/package/index?id=a484123441';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '成都环球中心洲际天堂大酒店丨微信商城618父亲节福利秒杀结束倒计时6小时~',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '感恩父亲节全场五折秒杀限量抢购',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '6月18日23:59秒杀通道关闭',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击即刻抢购',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

}