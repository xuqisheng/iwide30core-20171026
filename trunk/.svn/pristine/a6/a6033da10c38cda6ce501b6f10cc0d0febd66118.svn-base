<?php
class Fans_model extends CI_Model {
	function __construct() {
		parent::__construct ();
	}

    const TAB_FANS = 'fans';
    const TAB_FANS_SUBS = 'fans_subs';

    function count_all_fans($inter_id){

        $db = $this->load->database('iwide_r1',true);

        $sql = "
                SELECT
                    t1.id,t1.event,t1.source,t1.cur_status,t2.name,t2.hotel_id,t2.is_distributed,t1.event_time
                FROM
                    `iwide_fans_subs` t1
                LEFT JOIN
                    `iwide_hotel_staff` t2
                ON
                   t1.source = t2.qrcode_id
                WHERE
                   t1.inter_id = '{$inter_id}'
                AND
                   t1.inter_id = t2.inter_id
                AND
                   t1.source > 0
                GROUP BY
                    t1.openid
                ORDER BY
                    t1.event_time
                DESC
        ";


       return  $db->query($sql)->result_array();

    }


    function get_all_fans($inter_id,$offset=array(),$keyword=''){

        $db = $this->load->database('iwide_r1',true);

        $condition = '';

        $sql = "
                SELECT
                    t1.*,t2.event,t2.source,t2.cur_status
                FROM
                    `iwide_fans` t1,
                    `iwide_fans_subs` t2
                WHERE
                   t1.inter_id = '{$inter_id}'
                AND
                   t2.inter_id = '{$inter_id}'
                AND
                   t1.openid = t2.openid
        ";

        if(!empty($keyword)){
            $condition .=" AND t1.nickname like '%$keyword%'";
        }

        $condition .=' GROUP BY t1.id';

        if(!empty($offset)){
            $page = $offset['page'];
            $nums = $offset['nums'];
            $total = ($offset['page']-1)*$offset['nums'];
            $limit=" LIMIT {$total},{$nums}";
        }


        $res['data']=$db->query($sql.$condition.$limit)->result_array();

        $count_sql = "SELECT count(id) total FROM ({$sql}{$condition}) c1";

        $res['count'] = $db->query($count_sql)->row_array();

        return $res;


    }


    function count_self_fans($inter_id){

        $db = $this->load->database('iwide_r1',true);

        $sql = "SELECT count(fans.id) total FROM (SELECT id FROM `iwide_fans_subs` WHERE inter_id = '{$inter_id}' and source < 0 group by openid) fans";

        return  $db->query($sql)->row_array();

    }




}