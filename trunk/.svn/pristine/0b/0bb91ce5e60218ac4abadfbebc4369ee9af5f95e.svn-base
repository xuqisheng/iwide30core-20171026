<?php
if(!defined('BASEPATH')){
    exit ('No direct script access allowed');
}


/**
 * 分页方法
 *
 * @param  int $total 记录总条数
 * @param int  $page_cur 当前页码
 * @param  int $page_size 每页记录条数
 * @return  array $page
 */
function get_page($total = 0, $page_cur = 1, $page_size = 30)
{
    $page = array(
        'start'     => 0,  //当前页面起始记录编号
        'end'       => 0,
        'total'     => 1,	 //页码数
        'current'   => 1	 //当前页码
    );

    $total=intval($total);
    $page_cur=intval($page_cur);
    $page_size=intval($page_size);
    $page_size=empty($page_size)?10:$page_size;
    $page_total = ceil($total/$page_size);	//总页数
    $page_start = 0;	//当前页面起始记录编号

    //处理当前页
    $page_cur=max($page_cur,1);
    //$page_cur=min($page_cur,$page_total);
    //处理当前页面起始记录编号
    if($page_cur != 1)
    {
        $page_start = ($page_cur - 1) * $page_size;
    }

    $page['start'] = $page_start;
    $page['end'] = $page_size;
    $page['page_size'] = $page_size;
    $page['page_total'] = $page_total;
    $page['total'] = $total;
    $page['current'] = $page_cur;
    return $page;
}

/**
 * 分页
 * @param int $count
 * @param int $page_cur
 * @param int $page_total
 * @param string $url
 * @param int $max
 * @param string $ajaxCallBack
 * @return string
 */
function pagehtml($count, $page_cur, $page_total, $url, $max = null, $ajaxCallBack = '')
{
    if ($page_total <= 1)
    {
        return '';
    }
    list($count, $page_cur, $page_total, $max) = array(intval($count), intval($page_cur), intval($page_total), intval($max));
    if ($page_total <= 0) return '';
    ($max && $page_total > $max) && $page_total = $max;

    $ajaxurl = $ajaxCallBack ? " onclick=\"return $ajaxCallBack(this.href);\"" : '';
    @list($url, $mao) = explode('#', $url);
    $mao && $mao = '#' . $mao;
    $pages = '<div class="pages" id="pages">';
    $preArrow = $nextArrow = $firstPage = $lastPage = '';
    if ($page_total >7) {
        list($pre, $next) = array($page_cur - 1, $page_cur + 1);
        // 		$page_cur > 1 && $preArrow = "<a class=\"pages_pre\" href=\"{$url}page={$pre}$mao\"{$ajaxurl}>&#x4E0A;&#x4E00;&#x9875;</a>";
        $page_cur > 1 && $preArrow = "<a class=\"<\" href=\"{$url}page={$pre}$mao\"{$ajaxurl}><</a>";
        // 		$page_cur < $page_total && $nextArrow = "<a class=\"pages_next\" href=\"{$url}page={$next}$mao\"{$ajaxurl}>&#x4E0B;&#x4E00;&#x9875;</a>";
        $page_cur < $page_total && $nextArrow = "<a class=\">\" href=\"{$url}page={$next}$mao\"{$ajaxurl}>></a>";
    }
    $page_cur != 1 && $firstPage = "<a href=\"{$url}page=1$mao\"{$ajaxurl}>" . (($page_total > 7 && $page_cur - 3 > 1) ? '1</a>' : '1</a>');
    $page_cur != $page_total && $lastPage = "<a href=\"{$url}page={$page_total}$mao\"{$ajaxurl}>" . (($page_total > 7 && $page_cur + 3 < $page_total) ? "$page_total</a>" : "$page_total</a>");

    list($tmpPages, $preFlag, $nextFlag) = array('', 0, 0);
    $leftStart = ($page_total - $page_cur >= 3) ? $page_cur - 2 : $page_cur - (5 - ($page_total - $page_cur));
    for ($i = $leftStart; $i < $page_cur; $i++) {
        if ($i <= 1) continue;
        $tmpPages .= "<a href=\"{$url}page=$i$mao\"{$ajaxurl}>$i</a>";
        $preFlag++;
    }
    $tmpPages .= "<span class='current'>{$page_cur}</span>";
    $nextFlag = 4 - $preFlag + (!$firstPage ? 1 : 0);
    if ($page_cur < $page_total) {
        for ($i = $page_cur + 1; $i < $page_total && $i <= $page_cur + $nextFlag; $i++) {
            $tmpPages .= "<a href=\"{$url}page=$i$mao\"{$ajaxurl}>$i</a>";
        }
    }
    $pages .= $preArrow . $firstPage . $tmpPages . $lastPage . $nextArrow;
    $jsString = "var page=(value>$page_total) ? $page_total : value; " . ($ajaxurl ? "$ajaxCallBack('{$url}page='+page);" : " location='{$url}page='+page+'{$mao}';") . " return false;";
    $pages .= '</div>';
    return $pages;
}

/**
 * @param int $status =状态1正常，0异常；$msg=返回提示信息；$data=返回数据，支持数组
 * @param string $msg
 * @param array $data
 * @param string $type
 * @param bool $rsa
 * @return string 返回ajax请求结果
 * 返回ajax请求结果
 */
function ajax_return($status = 1, $msg = '', $data = array(), $type = 'json')
{
    $arr = array(
        "status"    => $status,
        "msg"       => $msg,
        "data"      => $data,
    );

    if($type == 'json')
    {
        header('content-type:application/json;charset=utf-8');
        echo json_encode($arr);
    }
    exit;
}

/**
 * 校验手机号码是否合法
 * @param $phone 手机号码
 * @return bool
 */
function check_phone($phone)
{
    $pattern_phone = "/^1[1345678]\d{9}$/i";
    if(preg_match($pattern_phone, $phone)){
        return true;
    }
    return false;
}

/**
 * formatMoney 金额浮点精度问题，避免四舍五入
 *
 * @param string $money
 * @static
 * @access public
 * @return void
 */
function formatMoney($money)
{
    return substr(sprintf('%.3f', $money), 0, -1);
}

/**
 * 获取IP
 */
function get_client_ip(){
    if(isset ($_SERVER)){
        if(isset ($_SERVER ["HTTP_X_FORWARDED_FOR"])){
            $realip = $_SERVER ["HTTP_X_FORWARDED_FOR"];
        } else{
            if(isset ($_SERVER ["HTTP_CLIENT_IP"])){
                $realip = $_SERVER ["HTTP_CLIENT_IP"];
            } else{
                $realip = $_SERVER ["REMOTE_ADDR"];
            }
        }
    } else{
        if(getenv("HTTP_X_FORWARDED_FOR")){
            $realip = getenv("HTTP_X_FORWARDED_FOR");
        } else{
            if(getenv("HTTP_CLIENT_IP")){
                $realip = getenv("HTTP_CLIENT_IP");
            } else{
                $realip = getenv("REMOTE_ADDR");
            }
        }
    }
    return $realip;
}