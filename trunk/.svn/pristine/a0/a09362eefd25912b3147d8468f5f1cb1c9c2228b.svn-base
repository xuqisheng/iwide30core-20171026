<?php
defined('BASEPATH') OR exit('No direct script access allowed');
/**
*	用户注册
*	@author  Frandon
*	@copyright www.iwide.cn
*	@version 4.0
*	@Email 489291589@qq.com
*/
class Reg extends MY_Front_Member
{
	//会员卡登录页面
	public function index(){
		$post_config_url = PMS_PATH_URL."adminmember/getregconfig";
		$post_config_data =  array(
			'inter_id'=>$this->inter_id,
        );
        $this->load->model('wx/publics_model', 'publics');
        $public = $this->publics->get_public_by_id( $this->inter_id );
        $data['public'] = $public;
        //请求注册配置
		$data['login_config'] = $this->doCurlPostRequest( $post_config_url , $post_config_data )['data'];
//		echo '<pre>';
//		print_r($data['login_config']);exit;
        $data['inter_id'] = $this->inter_id;
        $data['sales_id'] = $this->input->get('salesId')?intval($this->input->get('salesId')):0;
        if ($this->input->get('redir')){
            $data['succ_url']=urldecode($this->input->get('redir'));
            $data['redir']=urlencode($this->input->get('redir'));
        }else {
            $data['succ_url']=site_url('membervip/center').'id='.$this->inter_id;
            $data['redir']='';
        }
	   if($this->inter_id=='a480930558'){
           $this->template_show('member','junting','reg',$data);
        }else {
           $this->template_show('member',$this->_template,'reg',$data);
       }
	}
    
    /**
     * 2016-07-20
     * @author knight
     * 变更领取卡劵和礼包的方式,改为接口请求
     * 注册登录
     */
	public function savereg(){
        $this->session->unset_tempdata($this->inter_id.'vip_user');
        //验证图片验证码
        if(isset($_POST['smspic'])){
            if($_SESSION['code'] != $_POST['smspic']){
                $msginfo['err'] = '40003';
                $msginfo['msg'] = '图片验证码错误';
                echo json_encode($msginfo);exit;
            }
        }
        $this->load->model ( 'distribute/Fans_model' );
        if($this->inter_id == 'a472731996'){ //雅思特定制
            $fans = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);

            $SalesINFO = array();

            if(!empty($fans)){
                $hotel_id  = ($fans->hotel_id > 0 ) ? $fans->hotel_id : '';

                if($hotel_id){
                    $db = $this->load->database('iwide_r1',true);
                    $hotelInfo = $db->query("SELECT * FROM `iwide_hotel_additions` WHERE inter_id='$this->inter_id' AND hotel_id= $hotel_id ")->row();

                    if(!empty($hotelInfo) && isset($hotelInfo->hotel_web_id) && ( $hotelInfo->hotel_web_id > 0) ){
                        $soap = new SoapClient('http://121.41.82.114:9026/IWideService.asmx?wsdl');
                        $start = microtime(true);
                        $SalesINFO = $soap->GetSellerListBySellerDepID(array('SellerDepID'=>($hotelInfo->hotel_web_id)));
                        $end = microtime(true);
                        $time = round( $end - $start , 6 );
                        $this->load->library ("MYLOG");
                        // 转换成数组
                        $SalesINFO = json_decode(json_encode($SalesINFO), true);
                        MYLOG::pms_access_record('a472731996',date("Y-m-d H:i:s"),$time,'GetSellerListBySellerDepID','',json_encode(array('SellerDepID'=>$hotel_id['hotel_web_id'])),json_encode($SalesINFO),"雅思特");

                        if(!empty($SalesINFO)){
                            $_POST['seller_id'] = $SalesINFO['GetSellerListBySellerDepIDResult'];
                            $_POST['hotel_id'] = $hotelInfo->hotel_web_id;
                        }
                    }
                }
            }

            if(empty($SalesINFO) ){
                $_POST['seller_id'] = 99;
                $_POST['hotel_id'] = 99;
            }

        }
        
        if($this->inter_id == 'a480304439'){ //优程定制
            $fans = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);
            if(!empty($fans)){
                $_POST['hotel_id']  = ($fans->hotel_id > 0 ) ? $fans->hotel_id : '';
            } 
        }
        if($this->inter_id == 'a468919145'){ //恒大定制
            $fans = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);
        
            $SalesINFO = array();
        
            if(!empty($fans)){
                $hotel_id  = ($fans->hotel_id > 0 ) ? $fans->hotel_id : '';
                MYLOG::w($hotel_id.'&'.$this->inter_id.date('Y-M-d H:i:s',time()));
                if($hotel_id){
                    $db = $this->load->database('iwide_r1',true);
                    $hotelInfo = $db->query("SELECT * FROM `iwide_hotel_additions` WHERE inter_id='$this->inter_id' AND hotel_id= $hotel_id ")->row();
                    MYLOG::w(json_encode($hotelInfo).date('Y-M-d H:i:s',time()));
                    if(!empty($hotelInfo) && isset($hotelInfo->hotel_web_id)){
                        $_POST['hotel_id']  = $hotelInfo->hotel_web_id;
                    }else{
                        $_POST['hotel_id']='G000001';
                    }
                }
            }
        }
        if($this->inter_id == 'a457946152'||$this->inter_id == 'a484619482' ){ //隐居定制
            $fans = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);
        
            if(!empty($fans) && isset($fans->source)&&$fans->source>0){
                $_POST['cardSales']=$fans->source;
            }else{
                $_POST['cardSales']='0';
                    }
        
            if(!empty($fans)){
                $hotel_id  = ($fans->hotel_id > 0 ) ? $fans->hotel_id : '';
                MYLOG::w($hotel_id.'&'.$this->inter_id.date('Y-M-d H:i:s',time()));
                if($hotel_id){
                    $db = $this->load->database('iwide_r1',true);
                    $hotelInfo =$db->query("SELECT * FROM `iwide_hotel_additions` WHERE inter_id='$this->inter_id' AND hotel_id= $hotel_id ")->row();
                    MYLOG::w(json_encode($hotelInfo).date('Y-M-d H:i:s',time()));
                    if(!empty($hotelInfo) && isset($hotelInfo->hotel_web_id)){
                    
                        $_POST['hotel_id']  = $hotelInfo->hotel_web_id;
                    }else{
                        $_POST['hotel_id']='0';
                    }
                }
            }
        }
        

		$post_login_url = PMS_PATH_URL."member/reg";
		$post_login_data = array(
			'inter_id'=>$this->inter_id,
			'openid'=>$this->openid,
			'data'=>$_POST,
        );

        //如果有验证码,验证
        $conf_url = PMS_PATH_URL."adminmember/getregconfig";
        $post_data =  array('inter_id'=>$this->inter_id);
        //请求注册配置
        $regconfig = $this->doCurlPostRequest($conf_url,$post_data);
        $regconfig = isset($regconfig['data'])?$regconfig['data']:array();
        if(isset($regconfig['phonesms']) && $regconfig['phonesms']['show']=='1' && $regconfig['phonesms']['check']=='1'){
            if(!isset($_POST['phonesms'])) {
                echo json_encode(array('err'=>'40003','msg'=>'验证码不存在'));exit;
            }
            $checkSmsData = $post_login_data;
            $checkSmsData['data']['sms']=$_POST['phonesms'];
            $checkSmsData['phone']=isset($_POST['phone'])?$_POST['phone']:0;
            $checkSmsData['cellphone']=$checkSmsData['phone'];
            $checkSmsData['sms']=$_POST['phonesms'];
            $checkSmsData['smstype'] = isset($_POST['smstype'])?$_POST['smstype']:0;
            $res = $this->doCurlPostRequest(PMS_PATH_URL."member/checksms",$checkSmsData);
            if($res['err']>0){
                echo json_encode($res);exit;
            }
        }

		$login_result = $this->doCurlPostRequest( $post_login_url , $post_login_data );
		$is_package = false;
		if($login_result['err']=='0'){
		    /* 注册发送模板消息-添加模板消息队列-start */
            $this->load->model('membervip/common/Wxtemp_model','wxtemp');
            $this->load->model('membervip/common/Public_model','_public');
            $param = array(
                'inter_id'=>$this->inter_id,
                'openid'=>$this->openid,
                'business_model'=>4,
                'message_type'=>12
            );

            $member_lvl = $this->_public->get_field_by_level_config($this->inter_id);

            $membership_number = !empty($login_result['data']['membership_number'])?$login_result['data']['membership_number']:'';
            $nickname = !empty($login_result['data']['nickname'])?$login_result['data']['nickname']:'';
            $name = !empty($login_result['data']['name'])?$login_result['data']['name']:$nickname;
            $telephone = !empty($login_result['data']['telephone'])?$login_result['data']['telephone']:'';
            $member_lvl_id = !empty($login_result['data']['member_lvl_id'])?$login_result['data']['member_lvl_id']:0;
            $lvl_info = !empty($member_lvl[$member_lvl_id])?$member_lvl[$member_lvl_id]:'';
            $content = "{$membership_number}|{$name}|{$telephone}|{$lvl_info}";
            $_wxtemp = $this->wxtemp->create_message_queue($param,$content);
            MYLOG::w(@json_encode(array($_wxtemp,$param,$content)),'membervip/debug-log');
            /* 注册发送模板消息-添加模板消息队列-end */

            $this->load->model('membervip/admin/Distribution_model');
            $this->session->set_userdata($this->inter_id.$this->openid.'_logined',1);
            $rule_info = $this->Distribution_model->get_distribution_rule($this->inter_id,'reg','t');
            if($rule_info){
                /*注册分销绩效*/
                $saler_id = 0;
                switch ($rule_info['belonging']){
                    case 1://粉丝归属
                        $fan = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);
                        if(!empty($fan) && $fan->source > 0){
                            $saler_id = $fan->source;
                        }
                        break;
                    case 2://归属于链接分销号
                        $saler_id = intval($this->input->post('salesId'));
                        break;
                    case 3://优先归属于链接分销号
                        $saler_id = intval($this->input->post('salesId'));
                        if (!$saler_id){
                            $fan = $this->Fans_model->get_fans_beloning($this->inter_id,$this->openid);
                            if(!empty($fan) && $fan->source > 0){
                                $saler_id = $fan->source;
                            }
                        }
                        break;
                    default:
                        break;
                }
                if ($saler_id){
                    $dis_record = array(
                            'open_id' => $this->openid,
                            'type' =>  $rule_info['rule_type'],
                            'reward' => $rule_info['reward'],
                            'record_title'=> $rule_info['title'],
                            'sn'    => $login_result['data']['membership_number'],
                            'status' => 'f',
                    );
                    $this->load->model('distribute/Staff_model');
                    $sales = $this->Staff_model->get_my_base_info_saler($this->inter_id,$saler_id);
                    if ($sales){
                        $dis_record['sales_id'] = $sales['qrcode_id'];
                        $dis_record['sales_name'] = $sales['name'];
                        $dis_record['hotel_name']  = $sales['hotel_name'];
                        /*分销绩效记录写入*/
                        $record_id = $this->Distribution_model->add_distribution_record($this->inter_id,$dis_record);
                        if(!$record_id){
                            MYLOG::w("Distribution Record Reg Insert :".json_encode($dis_record).'|'.$this->inter_id." | Result Failed ",'distribution_record/failed');
                        }
                    }else{
                        MYLOG::w("Staff not found :".json_encode($dis_record).'|'.$this->inter_id.'|'.$saler_id." | Staff Failed ",'distribution_record/failed');
                    }
                }
            } /*end注册分销绩效*/


            $this->load->model('membervip/front/Member_model');
            $this->Member_model->check_user_info($this->inter_id,$this->openid);
            //获取优惠信息
            $post_card = array(
                'token'=>$this->_token,
                'inter_id'=>$this->inter_id,
                'is_active'=>'t',
                'type'=>'reg',
            );
            $rule_info= $this->doCurlPostRequest( PMS_PATH_URL."cardrule/get_package_card_rule_info" , $post_card );
            $rule_infos = array();
            if(isset($rule_info['data']) && !empty($rule_info['data'])){
                $rule_infos = $rule_info['data'];
            }


            if(!empty($rule_infos) && is_array($rule_infos)){
                $packge_url = INTER_PATH_URL.'package/give'; //领取礼包
                $card_url = PMS_PATH_URL.'cardrule/reg_gain_card'; //领取卡劵
                foreach ($rule_infos as $key => $item){
                    if( isset($item['is_package']) && $item['is_package']=='t'){
                        $package_data = array(
                            'token'=>$this->_token,
                            'inter_id'=>$this->inter_id,
                            'openid'=>$this->openid,
                            'uu_code'=>md5(uniqid()),
                            'package_id'=>$item['package_id'],
                            'card_rule_id'=>$item['card_rule_id'],
                            'number'=>$item['frequency']
                        );
                        $result = $this->doCurlPostRequest( $packge_url , $package_data );
                        if(isset($result['err']) && $result['err']=='0'){
                            $is_package = true;
                        }
                    }elseif (isset($item['is_package']) && $item['is_package']=='f'){
                        $card_data = array(
                            'token'=>$this->_token,
                            'inter_id'=>$this->inter_id,
                            'openid'=>$this->openid,
                            'card_id'=>$item['card_id'],
                            'type'=>'reg'
                        );
                        $this->doCurlPostRequest( $card_url , $card_data );
                    }
                }
            }
        }
        if(is_array($login_result)) $login_result['is_package'] = 2;
        if(!empty($login_result) && is_array($login_result) && $is_package===true) $login_result['is_package'] = 1;
		echo json_encode($login_result);
	}

	public function send_tmp_msg(){
        $retrun['code'] = '501';
        $retrun['msg'] = '参数不全';
	    $get = $_GET;
        //碧桂园注册送礼包
        if($this->inter_id=='a421641095'){
            $this->load->model('membervip/front/Kiminvited_model');
            $subdata['name'] = isset($get['name'])?$get['name']:'微信用户';
            $subdata['count'] = 1;
            $subdata['curtime'] = time();
            $retrun =  $this->Kiminvited_model->_send_tmp($this->inter_id,$this->openid,$subdata,5);
            $this->Kiminvited_model->_write_log($retrun,'_send_tmp');
        }
        echo json_encode($retrun);
    }

    public function pic_code(){
        //生成验证码图片
        $im = imagecreate(60,20); // 画一张指定宽高的图片
        $back = ImageColorAllocate($im, 245,245,245); // 定义背景颜色
        imagefill($im,0,0,$back); //把背景颜色填充到刚刚画出来的图片中
        $vcodes = "";
        srand((double)microtime()*1000000);
        //生成4位数字
        for($i=0;$i<4;$i++){
            $font = ImageColorAllocate($im, rand(100,255),rand(0,100),rand(100,255)); // 生成随机颜色
            $authnum=rand(1,9);
            $vcodes.=$authnum;
            imagestring($im, 5, 2+$i*10, 1, $authnum, $font);
        }
        $_SESSION['code'] = $vcodes;

        for($i=0;$i<100;$i++) //加入干扰象素
        {
            $randcolor = ImageColorallocate($im,rand(0,255),rand(0,255),rand(0,255));
            imagesetpixel($im, rand()%70 , rand()%30 , $randcolor); // 画像素点函数
        }
        ob_clean();
        Header("Content-type: image/PNG");
        ImagePNG($im);
        ImageDestroy($im);
    }

    public  function card_decode(){
        $inter_id = 'a449675133';
        $code = 'kiBJChZmznhM8PSWRVLvTA5Q09y1kMA5IsFQRrls268=';
        $token = 'YtoEhxUWPuMdAnaT_ZlADpP_M5gQtt2fsy5zHeDg8hDdPqmGXsUdcZj5IYdsSjg8U4rDTE72zPlTSdjp83z2WZ_rGdWaX4sUNJLwN9Exzw5mprQozz5GIsSwXpfpPBpHRHOcAEAEUB';
        $this->load->model('member/Wxcard');

        $this->load->model ( 'wx/access_token_model' );
        $url = "https://api.weixin.qq.com/card/code/decrypt?access_token=" .$token;
        $this->load->helper ( 'common' );
        $res = json_decode ( doCurlPostRequest ( $url, json_encode ( array ( 'encrypt_code' => $code ) ) ) );
        var_dump($res);
    }

    //会员卡激活页面
    public function activate(){
        /*会员卡验证*/
        $post_config_url = PMS_PATH_URL."adminmember/getloginconfig";
        $post_config_data =  array(
            'inter_id'=>$this->inter_id,
        );
        //请求注册配置
        $data['login_config'] = $this->doCurlPostRequest( $post_config_url , $post_config_data )['data'];
        $data['inter_id'] = $this->inter_id;
        $data['card_code'] = (isset($_GET['encrypt_code']))?$_GET['encrypt_code']:'';
        $data['card_id'] = (isset($_GET['card_id']))?$_GET['card_id']:'';
        if($this->inter_id=='a480930558'){
            $this->template_show('member','junting','reg',$data);
        }else {
            $this->template_show('member',$this->_template,'activate',$data);
        }
    }

    //激活会员卡保存
    public function do_activate(){
        $this->load->library('MYLOG');

        $this->session->unset_tempdata($this->inter_id.'vip_user');

        $post_login_url = PMS_PATH_URL."member/activatecard";
        $post_login_data = array(
            'inter_id'=>$this->inter_id,
            'openid'=>$this->openid,
            'data'=>$_POST,
        );

        //如果有验证码,验证
        $conf_url = PMS_PATH_URL."adminmember/getregconfig";
        $post_data =  array('inter_id'=>$this->inter_id);
        //请求注册配置
        $regconfig = $this->doCurlPostRequest($conf_url,$post_data);
        $regconfig = isset($regconfig['data'])?$regconfig['data']:array();
//        if(isset($regconfig['phonesms']) && $regconfig['phonesms']['show']=='1' && $regconfig['phonesms']['check']=='1'){
//            if(!isset($_POST['phonesms'])) {
//                echo json_encode(array('err'=>'40003','msg'=>'验证码不存在'));exit;
//            }
//            $checkSmsData = $post_login_data;
//            $checkSmsData['data']['sms']=$_POST['phonesms'];
//            $checkSmsData['phone']=isset($_POST['phone'])?$_POST['phone']:0;
//            $checkSmsData['cellphone']=$checkSmsData['phone'];
//            $checkSmsData['sms']=$_POST['phonesms'];
//            $checkSmsData['smstype'] = isset($_POST['smstype'])?$_POST['smstype']:2;
//            $res = $this->doCurlPostRequest(PMS_PATH_URL."member/checksms",$checkSmsData);
//            if($res['err']>0){
//                echo json_encode($res);exit;
//            }
//        }

        $login_result = $this->doCurlPostRequest( $post_login_url , $post_login_data );
        $is_package = false;
        $this->load->model('membervip/front/Member_model');
        $user_membercard_info = $this->Member_model->check_user_info($this->inter_id,$this->openid);
        MYLOG::w("get_member_info".json_encode($user_membercard_info)." | Result ".json_encode($login_result),'activate_wechat_card');
        //发礼包
        if($login_result['err']=='0' && isset($login_result['flag']) && $login_result['flag'] == 'register' ){




            //获取优惠信息
            $post_card = array(
                'token'=>$this->_token,
                'inter_id'=>$this->inter_id,
                'is_active'=>'t',
                'type'=>'reg',
            );
            $rule_info= $this->doCurlPostRequest( PMS_PATH_URL."cardrule/get_package_card_rule_info" , $post_card );
            $rule_infos = array();
            if(isset($rule_info['data']) && !empty($rule_info['data'])){
                $rule_infos = $rule_info['data'];
            }


            if(!empty($rule_infos) && is_array($rule_infos)){
                $packge_url = INTER_PATH_URL.'package/give'; //领取礼包
                $card_url = PMS_PATH_URL.'cardrule/reg_gain_card'; //领取卡劵
                foreach ($rule_infos as $key => $item){
                    if( isset($item['is_package']) && $item['is_package']=='t'){
                        $package_data = array(
                            'token'=>$this->_token,
                            'inter_id'=>$this->inter_id,
                            'openid'=>$this->openid,
                            'uu_code'=>md5(uniqid()),
                            'package_id'=>$item['package_id'],
                            'card_rule_id'=>$item['card_rule_id'],
                            'number'=>$item['frequency']
                        );
                        $result = $this->doCurlPostRequest( $packge_url , $package_data );
                        if(isset($result['err']) && $result['err']=='0'){
                            $is_package = true;
                        }
                    }elseif (isset($item['is_package']) && $item['is_package']=='f'){
                        $card_data = array(
                            'token'=>$this->_token,
                            'inter_id'=>$this->inter_id,
                            'openid'=>$this->openid,
                            'card_id'=>$item['card_id'],
                            'type'=>'reg'
                        );
                        $this->doCurlPostRequest( $card_url , $card_data );
                    }
                }
            }
        }

        //登录或者注册后，激活卡
        if($login_result['err']=='0'){
            $this->load->model('member/Wxcard');


            $code = $_POST['card_code'];
            $card_id = $_POST['card_id'];



            $this->Member_model->update_wechat_card_code($this->openid,$this->inter_id,$code,$card_id);

            $params['init_bonus'] = $user_membercard_info['credit'];
            $params['membership_number'] = $user_membercard_info['membership_number'];
            $params['card_id'] = $card_id; //暂时写死
            $params['code'] = $this->Wxcard->code_decrypt($this->inter_id,$code);
            $params['init_custom_field_value1'] = $this->Member_model->get_member_level_name($this->inter_id,$user_membercard_info['member_lvl_id']);
            //$params['init_custom_field_value2'] = 1;

            //激活卡
            $wechat_activate_res = $this->Wxcard->do_active($this->inter_id,$params);

            $reffer_url = isset($_SERVER['HTTP_REFERER'])? $_SERVER['HTTP_REFERER']:'';
            MYLOG::w("params : ".json_encode($params)." | Wechat Card Result ".json_encode($wechat_activate_res)." | refer URL :" .$reffer_url,'activate_wechat_card');

            if( isset($wechat_activate_res['errcode']) && $wechat_activate_res['errcode']==0){
                $login_result['err'] = 0;
            }else{
                $login_result['err'] = 40003;
                $login_result['msg'] = '激活微信卡券失败';
            }

        }

        if(is_array($login_result)) $login_result['is_package'] = 2;
        if(!empty($login_result) && is_array($login_result) && $is_package===true) $login_result['is_package'] = 1;
        echo json_encode($login_result);
    }

}
?>