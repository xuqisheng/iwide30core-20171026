<?php

defined ( 'BASEPATH' ) or exit ( 'No direct script access allowed' );
class Hotel_fans extends MY_Admin {
    protected $label_controller = '粉丝列表';
    protected $label_action = '';
    protected $common_data = array ();
    function __construct() {
        parent::__construct ();
        $this->inter_id = $this->session->get_admin_inter_id ();
        $this->module = 'publics';
        $this->common_data ['csrf_token'] = $this->security->get_csrf_token_name ();
        $this->common_data ['csrf_value'] = $this->security->get_csrf_hash ();
        $this->common_data ['inter_id'] = $this->inter_id;
        // $this->output->enable_profiler ( true );
    }

	public function main_model_name()
	{
		return 'hotel/Hotel_fans';
	}

    public function userlist(){

        $data = $this->common_data;
        $offset = array(
            'nums'=>20,
            'page'=>1
        );
        $keyword='';

        $this->load->model ( 'wx/Fans_model' );
        $this->load->model ( 'hotel/Hotel_model' );

        $post_data = $this->input->get();

        if(!empty($post_data['p'])){
            $offset['page']=$post_data['p'];
            $data['page'] = $post_data['p'];
        }else{
            $data['page'] = 1;
        }


        if(!empty($post_data['nums']))$offset['nums']=$post_data['nums'];
        if(!empty($post_data['key'])){
            $keyword=$post_data['key'];
            $data['key'] = $keyword;
        }else{
            $data['key'] = '';
        }

        $res = $this->Fans_model->get_all_fans($this->inter_id,$offset,$keyword);

        $data['fans'] = $res['data'];
        $data['count'] = $res['count']['total'];
        $data['page_nums'] = ceil($data['count']/$offset['nums']);
        $data['per_nums']=count($res['data']);

        $html= $this->_render_content($this->_load_view_file('userlist'), $data, false);

        echo $html;

    }



    public function fans_admin(){

        $data = $this->common_data;

        $data['new_fans'] = 0;
        $data['cancel_fans'] = 0;
        $data['total'] = 0;
        $data['self_fans'] = 0;
        $data['saler_fans'] = 0;

        $this->load->model ( 'wx/Fans_model' );
        $this->load->model ( 'hotel/Hotel_model' );

        $fans = $this->Fans_model->count_all_fans($this->inter_id);
        $self_fans = $this->Fans_model->count_self_fans($this->inter_id);

        $this->load->helper ( 'common' );
        $this->load->model ( 'wx/Access_token_model' );
        $access_token = $this->Access_token_model->get_access_token ( $this->inter_id );
        $get_fans = doCurlGetRequest('https://api.weixin.qq.com/cgi-bin/user/get?access_token='.$access_token);
        $get_fans = json_decode($get_fans);


        $today = strtotime(date("Y-m-d",time()));
        $last_day = strtotime(date("Y-m-d",time())) - 86400;


        $post_data = array(
            'begin_date'=>date("Y-m-d",time()-86400),
            'end_date'=>date("Y-m-d",time()-86400)
        );

        $url = 'https://api.weixin.qq.com/datacube/getusersummary?access_token='.$access_token;
        $usersummary = json_decode(doCurlPostRequest($url,json_encode($post_data)));


        if(!empty($usersummary->list)){
            $temp_new_fans = 0;
            $temp_cancel_fans = 0;
            foreach($usersummary->list as $arr_list){
                $temp_new_fans = $temp_new_fans + $arr_list->new_user;
                $temp_cancel_fans = $temp_cancel_fans + $arr_list->cancel_user;
            }
            $data['new_fans'] = $temp_new_fans;
            $data['cancel_fans'] = $temp_cancel_fans;
        }


        $data['hotels'] =  $this->Hotel_model->get_all_hotels($this->inter_id);
        $hotel_count = array();

        $data['total'] = isset($get_fans->total)?$get_fans->total:0;

        if(!empty($fans) && isset($get_fans->total)){

            foreach($fans as $fan){

//                if($fan['cur_status']==1){
//                    $data['total'] = $data['total'] + 1;
//                }

                if(!empty($fan['hotel_id'])){

                    if(!isset($hotel_count[$fan['hotel_id']])){
                        $hotel_count[$fan['hotel_id']]['total'] = 1;
                        $hotel_count[$fan['hotel_id']]['cancel'] = 0;
                        $hotel_count[$fan['hotel_id']]['saler'] = 0;
                        $hotel_count[$fan['hotel_id']]['scene'] = 0;
                    }else{
                        $hotel_count[$fan['hotel_id']]['total'] = $hotel_count[$fan['hotel_id']]['total'] + 1 ;
                    }

                    $data['saler_fans'] = $data['saler_fans'] + 1;

                }

                if(strtotime($fan['event_time']) > $last_day && strtotime($fan['event_time']) < $today){
                    if($fan['event']==2){
//                        $data['new_fans'] = $data['new_fans'] + 1;
                    }elseif($fan['event']==1){
//                        $data['cancel_fans'] = $data['cancel_fans'] + 1;
                        if(!empty($fan['hotel_id'])){
                            $hotel_count[$fan['hotel_id']]['cancel'] = $hotel_count[$fan['hotel_id']]['cancel'] + 1;
                        }
                    }
                }

                if(!empty($fan['hotel_id'])){
                    if($fan['is_distributed']==1){
                        $hotel_count[$fan['hotel_id']]['saler'] = $hotel_count[$fan['hotel_id']]['saler'] + 1;
                    }else{
                        $hotel_count[$fan['hotel_id']]['scene'] = $hotel_count[$fan['hotel_id']]['scene'] + 1;
                    }
                }

            }

        }

        if(!empty($self_fans)){
//            $data['self_fans'] = $data['self_fans'] + $self_fans['total'];
//            $data['total'] = $data['total'] + $self_fans['total'];
            $data['self_fans'] = $self_fans['total'];
        }

        $data['hotel_count'] = $hotel_count;


        $html= $this->_render_content($this->_load_view_file('fans_admin'), $data, false);

        echo $html;

    }






}
