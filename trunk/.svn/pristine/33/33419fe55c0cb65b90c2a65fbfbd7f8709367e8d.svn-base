<?php
namespace App\services\soma;

use App\libraries\Http;
use App\libraries\Support\Log;
use App\services\BaseService;
use App\services\Result;
use EasyWeChat\Foundation\Application;

/**
 *
 * 以后使用命名空间！！！
 *
 *
 * Class WxService
 * @package App\services\soma
 * @author renshuai  <renshuai@mofly.cn>
 *
 * @date 2017-06-21
 */
class WxService extends BaseService
{
    /**
     * 秒杀订阅关注
     */
    const QR_CODE_KILLSEC_SUBSCRIBE = '1234321';

    /**
     * 支付成功关注
     */
    const QR_CODE_PAY_SUCCESS_SUBSCRIBE = '1235321';

    /**
     * 获取服务实例方法
     * @return WxService
     */
    public static function getInstance()
    {
        return self::init(self::class);
    }

    /**
     * for test
     *
     * @return Application
     * @author renshuai  <renshuai@mofly.cn>
     */
    public function getApp()
    {
        $info = $this->getCI()->public_info;
        $config = [
            'debug' => true,
            'app_id'  => $info['app_id'],
            'secret'  => $info['app_secret'],
            'token'   => $info['token'],
            'aes_key' => $info['aes_key'],
            'log' => [
                'level'      => 'debug',
                'permission' => 0777,
                'file'       => APPPATH . 'logs/soma/easywechat.log',
            ],
            'guzzle' => [
                'timeout' => 3.0,
            ],
        ];

        if (ENVIRONMENT === 'production') {
            $config['debug'] = false;
            $config['log']['level'] = 'info';
        }

        $app = new Application($config);

        $this->getCI()->load->model ('wx/access_token_model');
        $access_token = $this->getCI()->access_token_model->get_access_token($info['inter_id'], true);

        $currentTime = time();
        if ($access_token['expire'] > $currentTime  && $access_token['expire'] - $currentTime > 1500 ) {
            $app->access_token->setToken($access_token['access_token'], $access_token['expire'] - time());
        } else {
            $access_token = $this->getCI()->access_token_model->reflash_access_token($info['inter_id'], true);
            $app->access_token->setToken($access_token['ticket'], $access_token['expire_in'] - time());
        }

        return $app;
    }

    /**
     * 获取一个二维码
     *
     * @param int $id
     * @return Result|\EasyWeChat\Support\Collection
     * @author renshuai  <renshuai@mofly.cn>
     */
    public function getQrcode($id)
    {
        $result = new Result();
        $redis = $this->getCI()->get_redis_instance();
        if (empty($redis)) {
            $result->setMessage('系统错误');
            return $result;
        }

        $interID = $this->getCI()->inter_id;
        $key = "QRCODE_FOREVE_{$interID}_{$id}";
        $url = $redis->get($key);

        if (empty($url)){
            $app = $this->getApp();

            $qrResult = $app->qrcode->forever($id);
            $ticket = $qrResult->ticket;
            $url = $app->qrcode->url($ticket);

            $redis->set($key, $url);
            $redis->expire($key, 3600 * 24 * 100);

        }

        $result->setStatus(Result::STATUS_OK);
        $result->setData($url);
        return $result;
    }


    public function subscribemsg($redirectUrl)
    {
        $arr = [];



        //有节目
        $interID = 'a469428180';
        $appID = 'wxa0d02285152b63ad';
        $templageID = '27alaDJVYgvB020ib5nLzmtNSN7Ob2dpsJoo4tT2B9E';

        $redirectUrl = urlencode($redirectUrl);
        $arr[$appID] = "https://mp.weixin.qq.com/mp/subscribemsg?action=get_confirm&appid={$appID}&scene=4200&template_id={$templageID}&redirect_url={$redirectUrl}&reserved=help#wechat_redirect";

        return $arr;
    }

    public function subscribemsg1($redirectUrl)
    {
        $arr = [];
        //放心住
        $interID = 'a450089706';
        $appID = 'wx9a938bc5cd0aeacc';
        $templageID = 'ViwYokCgkwdfmB4kgnw8rk5bXZv9hpJWvbMm5Epk7rg';
        $redirectUrl = urlencode($redirectUrl);
        $arr[$appID] = "https://mp.weixin.qq.com/mp/subscribemsg?action=get_confirm&appid={$appID}&scene=4200&template_id={$templageID}&redirect_url={$redirectUrl}&reserved=help#wechat_redirect";
        return $arr;
    }
    public function sendMsg(Array $arr)
    {
        Log::debug('sendMsg 1', $arr);
        $this->getCI()->load->model('wx/access_token_model');
        $interID = $arr['inter_id'];
        $access_token = $this->getCI()->access_token_model->get_access_token($interID, true);
        $token = $access_token['access_token'];
        $api = "https://api.weixin.qq.com/cgi-bin/message/template/subscribe?access_token={$token}";

        Log::debug('sendMsg 2', [$api]);

        $client = new Http();
        $requestData = [
            'touser' => $arr['openid'],
            'template_id' => $arr['template_id'],
            'scene' => $arr['scene'],
            'title' => $arr['title'],
            'data' => $arr['data']
        ];
        $result = $client->json($api, $requestData, 256, ['access_token' => $token]);
        $data = $client->parseJSON($result);

        Log::debug('sendMsg 3', $data);

        $result = $client->post($api, $requestData);
        $data = $client->parseJSON($result);
        Log::debug('sendMsg 4', $data);

        return $data;

    }


}