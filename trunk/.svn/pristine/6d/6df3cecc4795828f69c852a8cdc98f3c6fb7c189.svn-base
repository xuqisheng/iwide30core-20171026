<?php
/*
 * 转账
 */
class Transfer extends MY_Controller {
	function __construct() {
		parent::__construct ();
		$this->debug = $this->input->get ( 'debug' );
		error_reporting ( 0 );
		if (! empty ( $this->debug )) {
			error_reporting ( E_ALL );
			ini_set ( 'display_errors', 1 );
        }
		$this->load->library('MYLOG');
	}
    private function check_arrow(){//访问限制
        //var_dump($_SERVER['REMOTE_ADDR']);die;
        return true;
        $arrow_ip = array('10.25.168.86','10.25.3.85');//只允许服务器自动访问，不能手动
        if(!in_array($_SERVER['REMOTE_ADDR'],$arrow_ip)/*&&$_SERVER['SERVER_ADDR']!=$_SERVER['REMOTE_ADDR']*/){
            exit('非法访问！');
        }
    }

    protected function _load_cache( $name='Cache' ){
        if(!$name || $name=='cache')
            $name='Cache';
        $this->load->driver('cache', array('adapter' => 'redis', 'backup' => 'file', 'key_prefix' => 'dis_ato_'), $name );
        return $this->$name;
    }  

    //处理订单
    public function check(){
        /*$this->check_arrow();

        set_time_limit ( 0 );
        @ini_set('memory_limit','512M');

        $cache= $this->_load_cache();
        $redis= $cache->redis->redis_instance();

        //检查是否只有一个实例
        $key = 'subatips_send_lock';
        $ok = $redis->setNX($key,'on');//var_dump($redis->del($key));die;
        if(!$ok){
            $last_time = $redis->get('subatips_last_time');//var_dump($last_time);die;
            if(!empty($last_time) && $last_time+600 < time()){//超过十分钟
                die;
            }
            echo '有其他任务正在运行，请稍候！';exit;
        }*/

        //找出未分账订单
        $this->load->model ( 'iwidepay/iwidepay_transfer_model' );
        $orders = $this->iwidepay_transfer_model->get_unsplit_orders();//$orders = array($orders[0]);//var_dump($orders);die;
        if(empty($orders)){
            MYLOG::w('无可分账的数据', 'iwidepay/transfer');
            return false;
        }
        //所有规则一起拿
        $all_rules = $this->iwidepay_transfer_model->get_all_rules();
        if(empty($all_rules)){
            MYLOG::w('无可分账的规则', 'iwidepay/transfer');
            return false;
        }
        $rules = array();
        foreach($all_rules as $ak=>$av){
            $rules[$av['inter_id']][] = $av;
        }
        $configedata = array('saler_inter_id'=>'jingfangka','iwide'=>'jingfangka','iwide_tips'=>'jingfangka');
        //取金房卡银行信息
        $iwide_bank = array();
        $iwide_bank_res = $this->iwidepay_transfer_model->get_bank_info($configedata['iwide'],'-1');
        foreach($iwide_bank_res as $ik=>$iv){
            $iwide_bank[$iv['inter_id'].'_'.$iv['hotel_id'].'_'.$iv['type']] = $iv;
        }
        //取分账规则 根据inter_id拿
        foreach($orders as $k=>$v){
            //查询对应的inter_id规则
            if(empty($rules[$v['inter_id']])){
                 MYLOG::w('inter_id:'.$inter_id.'-无可分账的规则', 'iwidepay/transfer');
                 continue;
            }
            $rules_data = $this->handle_rules($rules[$v['inter_id']],$v['inter_id'],$v['module'],$v['hotel_id']);
            $for_last = '';//是否剩下
            //拿出cost的费用 只有 1待定 2待分 才要算这步，5未分完的不用了
            if($v['transfer_status'] == 1 || $v['transfer_status'] == 2){
                $cost = isset($rules_data['regular_jfk_cost'])?$rules_data['regular_jfk_cost']:0;
                if(empty($cost)){
                    MYLOG::w('inter_id:'.$v['inter_id'].'-cost成本为空', 'iwidepay/transfer');
                    continue;
                }
                $num_type = is_numeric($cost)?1:2;//1是金额 2 是百分比
                if($num_type==2){
                    $cost = str_replace('%', '', $cost);
                    $cost = round($v['trans_amt'] * $cost / 100);
                }
                if($v['transfer_status'] == 1){
                    $for_last = 'regular_hotel';//剩下的都给酒店
                }
            }elseif($v['transfer_status'] == 5 && !empty($v['sell_hotel_id'])){//计算分了多少钱，剩下的留给核销的酒店
                //统计计算改订单已经分了的钱
                $res = $this->handle_sell_order($v,$rules_data);
                continue;
            }else{
                continue;
            }
            
            $money_arr = array();
            //是分销的单 做处理
            if($v['is_dist'] && $v['dist_amt'] > 0){
                $money_arr['regular_dist'] = $v['dist_amt'];//分销员的
                $for_last = 'regular_hotel';//剩下的 这里默认是regular_hotel 后面根据配置进行修改
            }
            $regular = array('regular_group','regular_hotel','regular_jfk');
            foreach($rules_data as $_key=>$_value){
                if(in_array($_key,$regular)){
                    if(empty($_value)){
                        //为空的不处理
                    }elseif($_value == '-1'){//剩下的全部给 
                        $for_last = $_key;
                    }elseif(is_numeric($_value)){
                        $money_arr[$_key] = $_value;
                    }else{
                        $persent = str_replace('%', '', $_value);
                        $money_arr[$_key] = round($v['trans_amt'] * $persent / 100);
                    }
                }
                if($_key == 'regular_jfk_cost'){//金房卡成本费用
                    $money_arr[$_key] = $cost;
                }
            }

            $bank_info_arr = $this->iwidepay_transfer_model->get_bank_info($v['inter_id'],-1,'');
            foreach($bank_info_arr as $bk=>$bv){
                $bank_arr[$bv['hotel_id'] .'_' . $bv['type']] = $bv;
            }
            unset($bank_info_arr);
            
            $inser_data = array();
            $transfer = $bank_info = array();
            $transfer['inter_id'] = $v['inter_id'];
            $transfer['hotel_id'] = $v['hotel_id'];
            $transfer['order_no'] = $v['order_no'];
            $transfer['pay_id'] = $v['pay_id'];//民生订单号
            $transfer['module'] = $v['module'];
            $transfer['pay_type'] = $v['pay_type'];
            $transfer['rule_id'] = $rules_data['rule_id'];
            $transfer['status'] = 1;//初始状态 待转
            $transfer['add_time'] = date('Y-m-d H:i:s');
            $money = 0;
            foreach($money_arr as $mk=>$mv){
                if($for_last && $mk==$for_last){//如果是剩下的配置，跳过，后面一步处理
                    continue;
                }
                //处理银行卡信息
                if($mk == 'regular_group'){
                    $transfer['type'] = 'group';
                    $bank_info = isset($bank_arr['0_hotel'])?$bank_arr['0_hotel']:'';
                }elseif($mk == 'regular_hotel'){
                    $transfer['type'] = 'hotel';
                    $bank_info = isset($bank_arr[$v['hotel_id'] .'_hotel'])?$bank_arr[$v['hotel_id'] .'_hotel']:'';
                }elseif($mk == 'regular_dist'){
                    $transfer['type'] = 'dist';
                    $bank_info = isset($iwide_bank[$configedata['iwide'].'_0_dist'])?$iwide_bank[$configedata['iwide'].'_0_dist']:'';
                }elseif($mk == 'regular_jfk'){
                    $transfer['type'] = 'jfk';
                    $bank_info = isset($iwide_bank[$configedata['iwide'].'_0_jfk'])?$iwide_bank[$configedata['iwide'].'_0_jfk']:'';
                }elseif($mk == 'regular_jfk_cost'){
                    $transfer['type'] = 'cost';
                    $bank_info = isset($iwide_bank[$configedata['iwide'].'_0_jfk'])?$iwide_bank[$configedata['iwide'].'_0_jfk']:'';
                    //$transfer['status'] = 0;
                }
                if(empty($bank_info)){
                    MYLOG::w('inter_id:'.$v['inter_id'].'--order_id:'.$v['order_no'].'-无银行卡信息', 'iwidepay/transfer');
                    //continue;
                }
                $transfer['m_id'] = !empty($bank_info['id'])?$bank_info['id']:0;
                $transfer['bank'] = !empty($bank_info['bank'])?$bank_info['bank']:'';
                $transfer['bank_card_no'] = !empty($bank_info['bank_card_no'])?$bank_info['bank_card_no']:'';
                $transfer['bank_user_name'] = !empty($bank_info['bank_user_name'])?$bank_info['bank_user_name']:'';
                $transfer['is_company'] = !empty($bank_info['is_company'])?$bank_info['is_company']:'';
                $transfer['amount'] = $mv;
                $money += $mv;
                $inser_data[] = $transfer;
            }
            //单独处理剩下的
            if($for_last){
                //如果订单状态是1 待分 并且核销的酒店id存在
                if($v['transfer_status'] == 1 && !empty($v['sell_hotel_id'])){//核销掉的
                    $transfer['hotel_id'] = $v['sell_hotel_id'];
                    $bank_info = isset($bank_arr[$v['sell_hotel_id'] .'_hotel'])?$bank_arr[$v['sell_hotel_id'] .'_hotel']:'';
                    if(empty($bank_info)){
                    //报警
                        MYLOG::w('inter_id:'.$v['inter_id'].'--order_id:'.$v['order_no'].'-无银行卡信息', 'iwidepay/transfer');
                    }
                    $transfer['type'] = 'hotel';
                    $transfer['m_id'] = !empty($bank_info['id'])?$bank_info['id']:0;
                    $transfer['bank'] = !empty($bank_info['bank'])?$bank_info['bank']:'';
                    $transfer['bank_card_no'] = !empty($bank_info['bank_card_no'])?$bank_info['bank_card_no']:'';
                    $transfer['bank_user_name'] = !empty($bank_info['bank_user_name'])?$bank_info['bank_user_name']:'';
                    $transfer['is_company'] = !empty($bank_info['is_company'])?$bank_info['is_company']:'';
                    $transfer['amount'] = $v['trans_amt'] - $money;//剩下的给门店
                    $inser_data[] = $transfer;
                }elseif($v['transfer_status'] == 1 && empty($v['sell_hotel_id'])){//没有核销的
                    //$transfer['hotel_id'] = $v['sell_hotel_id'];
                }else{
                    $b_type = str_replace('regular_', '', $for_last);
                    $bank_info = isset($bank_arr[$v['hotel_id'] .$b_type])?$bank_arr[$v['hotel_id'] .$b_type]:'';
                    if(empty($bank_info)){
                    //报警
                        MYLOG::w('inter_id:'.$v['inter_id'].'--order_id:'.$v['order_no'].'-无银行卡信息', 'iwidepay/transfer');
                    }
                    $transfer['type'] = $b_type;
                    $transfer['m_id'] = !empty($bank_info['id'])?$bank_info['id']:0;
                    $transfer['bank'] = !empty($bank_info['bank'])?$bank_info['bank']:'';
                    $transfer['bank_card_no'] = !empty($bank_info['bank_card_no'])?$bank_info['bank_card_no']:'';
                    $transfer['bank_user_name'] = !empty($bank_info['bank_user_name'])?$bank_info['bank_user_name']:'';
                    $transfer['is_company'] = !empty($bank_info['is_company'])?$bank_info['is_company']:'';
                    $transfer['amount'] = $v['trans_amt'] - $money;//剩下的给门店
                    $inser_data[] = $transfer;
                }
            }
            //商城的酒店 先分给集团
            if($v['module'] == 'mall'){
                $group_key = $hotel_key = $hotel_key_value =  0;
                foreach($inser_data as $ik=>$iv){
                    if($iv['type'] == 'group'){
                        $group_key = $ik;
                    }
                    if($iv['type'] == 'hotel'){
                        $hotel_key_value = $iv['amount'];
                        $hotel_key = $ik;
                    }
                }
                $inser_data[$group_key]['amount'] = $inser_data[$group_key]['amount'] + $hotel_key_value;
                unset($inser_data[$hotel_key]);
            }//var_dump($inser_data);die;
            //汇总，分账金额和订单金额不一致
            $sum_amount = 0;
            foreach($inser_data as $ins_key =>$ins_val){
                $sum_amount += $ins_val['amount'];
            }
            if($sum_amount != $v['trans_amt']){
                MYLOG::w('inter_id:'.$v['inter_id'].'--order_no:'.$v['order_no'].'-分账金额与订单金额总和不一致', 'iwidepay/transfer');
                continue;
            }
            //insert
            $res = $this->db->insert_batch('iwidepay_transfer',$inser_data);
            if($res){//插入成功
               // $data[$v['order_no']][] = $transfer;
            }else{
                MYLOG::w('inter_id:'.$v['inter_id'].'--order_no:'.$v['order_no'].'-入库失败，该条order_no订单停止', 'iwidepay/transfer');
                return false;
            }

            $is_success = $this->split_to_transfer($v['inter_id'],$v['order_no'],$v['module']);
            if(!$is_success){
                //报警
            }
            if($v['transfer_status'] == 1 && !empty($v['sell_hotel_id'])){//核销掉的
                $this->db->where(array('inter_id'=>$v['inter_id'],'order_no'=>$v['order_no'],'transfer_status'=>1));
                if($is_success){//匹配成功
                    $this->db->update('iwidepay_order',array('transfer_status'=>3));
                }else{
                    $this->db->update('iwidepay_order',array('transfer_status'=>4));
                }
            }elseif($v['transfer_status'] == 1 && empty($v['sell_hotel_id'])){//没核销
                $this->db->where(array('inter_id'=>$v['inter_id'],'order_no'=>$v['order_no'],'transfer_status'=>1));
                if($is_success){
                    $this->db->update('iwidepay_order',array('transfer_status'=>5));
                }else{
                    $this->db->update('iwidepay_order',array('transfer_status'=>4));
                }
            }else{
                $this->db->where(array('inter_id'=>$v['inter_id'],'order_no'=>$v['order_no'],'transfer_status'=>2));
                if($is_success){
                    $this->db->update('iwidepay_order',array('transfer_status'=>3));//3是已分
                }else{
                    $this->db->update('iwidepay_order',array('transfer_status'=>4));
                }
            }
            
        }  
        echo 'done';die;   
        //遍历结束，解锁
       // $redis->del($key);
    } 

    //处理通票的那种单
    protected function handle_sell_order($orders,$rules){
         //先拿出已经分掉的金额
        $trans_sum_amt = $this->iwidepay_transfer_model->gather_transfer_amt($orders['inter_id'],$orders['order_no'],$orders['module']);
        $transfer['inter_id'] = $orders['inter_id'];
        $transfer['hotel_id'] = $orders['sell_hotel_id'];//已经核销的
        $transfer['order_no'] = $orders['order_no'];
        $transfer['pay_id'] = $orders['pay_id'];//民生订单号
        $transfer['module'] = $orders['module'];
        $transfer['pay_type'] = $orders['pay_type'];
        $transfer['rule_id'] = $rules['rule_id'];
        $transfer['status'] = 1;//初始状态 待转
        $transfer['add_time'] = date('Y-m-d H:i:s');
        $transfer['type'] = 'hotel';
        $bank_info = $this->iwidepay_transfer_model->get_bank_info($orders['inter_id'],$orders['sell_hotel_id'],'hotel');
        $transfer['m_id'] = !empty($bank_info['id'])?$bank_info['id']:0;
        $transfer['bank'] = !empty($bank_info['bank'])?$bank_info['bank']:'';
        $transfer['bank_card_no'] = !empty($bank_info['bank_card_no'])?$bank_info['bank_card_no']:'';
        $transfer['bank_user_name'] = !empty($bank_info['bank_user_name'])?$bank_info['bank_user_name']:'';
        $transfer['is_company'] = !empty($bank_info['is_company'])?$bank_info['is_company']:'';
        $transfer['amount'] = $orders['trans_amt'] - $trans_sum_amt;//剩下的给门店

        $res = $this->db->insert('iwidepay_transfer',$transfer);
        $is_success = $this->split_to_transfer($orders['inter_id'],$orders['order_no'],$orders['module']);
        if(!$is_success){
            //报警
        }
        $this->db->where(array('inter_id'=>$orders['inter_id'],'order_no'=>$orders['order_no'],'transfer_status'=>5));
        if($is_success){
            $this->db->update('iwidepay_order',array('transfer_status'=>3));//3是已分
        }else{
            $this->db->update('iwidepay_order',array('transfer_status'=>4));
        }
        return true;
    }

    //规则处理
    protected function handle_rules($rules,$inter_id,$module,$hotel_id){
            $rules_data = array();
            $single = 0;//没有单独设置
            $rules_list = $sin_hotel = $def_hotel = array();
            foreach($rules as $ruk=>$ruv){
                if($ruv['module'] == $module){
                    if($ruv['hotel_id'] == $hotel_id){//集团或者酒店
                        $sin_hotel = $ruv;
                        $single = 1;//存在单独设的
                        break;
                    }elseif($ruv['hotel_id'] == -1){//默认设置
                        $def_hotel = $ruv;
                    }
                }
            }
            if($single){
                $rules_data = $sin_hotel;
            }else{
                $rules_data = $def_hotel;
            }
            return $rules_data;
    }

    //分账和转账对比
    protected function split_to_transfer($inter_id,$order_no,$module){
        //先查询两个表记录条数是不是一致
            $split_count = $this->iwidepay_transfer_model->get_split_count($inter_id,$order_no,$module);
            $transfer_count = $this->iwidepay_transfer_model->get_transfer_count($inter_id,$order_no,$module);
            if($split_count != $transfer_count){
                MYLOG::w('inter_id:'.$inter_id.'--order_no:'.$order_no.'-两个表记录条数不一致', 'iwidepay/transfer');
                return false;
            }
            //根据订单号和inter_id连表查询分账记录和转账记录 
            $record = $this->iwidepay_transfer_model->get_split_transfer_record($inter_id,$order_no,$module);
            if(empty($record)){
                MYLOG::w('inter_id:'.$inter_id.'--order_no:'.$order_no.'-分账转账无记录', 'iwidepay/transfer');
                return false;
            }
            $is_split = 1;//是否成功分账
            foreach($record as $key=>$values){
                if($values['type']==$values['s_type'] && $values['hotel_id'] == $values['s_hotel_id'] && $values['order_no'] == $values['s_order_no']){//确定为同一条记录
                    if($values['amount'] == $values['s_amount'] && $values['m_id'] == $values['s_m_id']){//相同的
                        //相同，更新状态，或者转账
                        if($values['type'] == 'cost'){
                            $update = array('status'=>0,'check_time'=>date('Y-m-d H:i:s'));
                        }else{
                            $update = array('status'=>2,'check_time'=>date('Y-m-d H:i:s'));
                        }
                        $this->db->where(array('id'=>$values['id']));
                        $this->db->update('iwidepay_transfer',$update);
                    }else{//不相同
                        MYLOG::w('inter_id:'.$inter_id.'--order_no:'.$order_no.'-匹配异常', 'iwidepay/transfer');
                        $update = array('status'=>3,'check_time'=>date('Y-m-d H:i:s'));//匹配异常
                        $this->db->where(array('id'=>$values['id']));
                        $this->db->update('iwidepay_transfer',$update);
                        $is_split = 0;//一次失败，就是失败
                    }
                }
            }
            return $is_split;
    }

    
}