<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class Cron_nz extends MY_Controller {

    protected $_basic_path;
    protected $_redis = null;

    public function __construct() {
        parent::__construct();
        $this->_basic_path = APPPATH . '..' . DS . 'www_admin' . DS . 'public' . DS . 'import' . DS;
        $this->_redis = $this->get_redis_instance();
        if($this->_redis == null)
        {
            die('redis connect fail!');
        }
    }

    protected function _parse_csv_file($file) {
        $csv = fopen($file, 'r');
        $csv_data = array(); 
        $n = 0; 
        while ($data = fgetcsv($csv)) { 
            $num = count($data); 
            for ($i = 0; $i < $num; $i++) { 
                $csv_data[$n][$i] = mb_convert_encoding($data[$i], 'utf-8', 'gbk');//$data[$i]; 
            } 
            $n++; 
        }
        return $csv_data;
    }

    protected function get_inter_domain($inter_id)
    {
        $this->load->model('wx/publics_model', 'wxp_model');
        $public = $this->wxp_model->get_public_by_id($inter_id);
        return empty($public['domain']) ? false : $public['domain'];
    }

    protected function get_target_openids_from_csv($inter_id, $file)
    {
        // 抽取需要发送的订单号、openid
        $csv_data = $this->_parse_csv_file($file);
        unset($csv_data[0]);

        $order_ids = $openids = array();
        foreach ( $csv_data as $row)
        {
            if(!empty($row[0]))
            {
                $order_ids[] = $row[0];
            }
            if(!empty($row[1]) && !in_array($row[1], $openids))
            {
                $openids[] = $row[1];
            }
        }

        //初始化数据库分片配置，微信接口关闭订单需要初始化shard_id
        $this->load->model('soma/shard_config_model', 'model_shard_config');
        $this->current_inter_id= $inter_id;
        $this->db_shard_config= $this->model_shard_config->build_shard_config( $inter_id );

        if(!empty($order_ids))
        {
            $this->load->model('soma/Sales_order_model', 'o_model');
            $orders = $this->o_model->get_order_list('package', $inter_id, array('order_id' => $order_ids));
            if(!empty($orders))
            {
                foreach($orders as $order)
                {
                    if(!in_array($order['openid'], $openids))
                    {
                        $openids[] = $order['openid'];
                    }
                }
            }
        }

        return $openids;
    }

    /**
     * Gets the redis instance.
     *
     * @param      string $select The select
     *
     * @return     Redis|null  The redis instance.
     */
    public function get_redis_instance($select = 'soma_redis')
    {
        $this->load->library('Redis_selector');
        if ($redis = $this->redis_selector->get_soma_redis($select)) {
            return $redis;
        }
        return null;
    }

    public function wdm()
    {
        $inter_id = 'a495077577';
        $template_id = 'mAvBTWgcXSs1gmqeyd3bEL0FUZdWOyWECmr7foF0aSg';
        $file = $this->_basic_path . 'wdm.csv';

        $data['template_id'] = $template_id;
        $data['url'] = 'http://mp.weixin.qq.com/s/rzdXvxyLA2AFHRgmPkwg1Q';
        $data['topcolor'] = '#000000';
        $subdata['first'] = array(
            'value' => '粉丝福利｜您有一份福利待确认',
            'color' => '#000000' 
        );
        $subdata['keyword1'] = array(
            'value' => '电影票、音乐会门票',
            'color' => '#000000'
        );
        $subdata['keyword2'] = array(
            'value' => '即日起至2017年6月18日22:00',
            'color' => '#000000'
        );
        $subdata['remark'] = array(
            'value' => '点击详情立即参与活动',
            'color' => '#000000'
        );
        $data['data'] = $subdata;

        $openids = $this->get_target_openids_from_csv($inter_id, $file);
        $this->load->model('soma/Message_wxtemp_template_model', 't_model');
        $base_key = 'Soma_cron_nz:' . date('Y-m-d') . ':' . __FUNCTION__ . ':';
        foreach ($openids as $openid) {
            $redis_key = $base_key . $openid;
            if($this->_redis->exists($redis_key))
            {
                continue;
            }
            $data['touser'] = $openid;
            $res = $this->t_model->send_template(json_encode($data), $inter_id);
            $this->_redis->set($redis_key, json_encode($res));
        }
        echo 'success';
    }

}