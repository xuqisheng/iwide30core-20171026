<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="<?php echo base_url(FD_PUBLIC) ?>/js/html5shiv.min.js"></script>
    <script src="<?php echo base_url(FD_PUBLIC) ?>/js/respond.min.js"></script>
<![endif]-->
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

<?php 
/* 顶部导航 */
echo $block_top;
?>

<?php 
/* 左栏菜单 */
echo $block_left;
?>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1><?php echo isset($breadcrumb_array['action'])? $breadcrumb_array['action']: ''; ?>
            <small></small>
          </h1>
          <ol class="breadcrumb"><?php echo $breadcrumb_html; ?></ol>
        </section>
        <!-- Main content -->
        <section class="content">

<?php echo $this->session->show_put_msg(); ?>
<?php $pk= $model->table_primary_key(); ?>
<!-- Horizontal Form -->
<div class="box box-info">
	<div class="box-header with-border">
		<h3 class="box-title"><?php echo ( $this->input->post($pk) ) ? '编辑': '新增'; ?>信息</h3>
	</div>
	<!-- /.box-header -->
<!-- form start -->
	<?php 
	echo form_open( Soma_const_url::inst()->get_url('*/*/edit_post'), array('class'=>'form-horizontal','enctype'=>'multipart/form-data'), array($pk=>$model->m_get($pk) ) ); ?>
		<div class="box-body">
            <?php foreach ($fields_config as $k=>$v): ?>
				<?php 
                if($check_data==FALSE) echo EA_block_admin::inst()->render_from_element($k, $v, $model); 
                else echo EA_block_admin::inst()->render_from_element($k, $v, $model, FALSE); 

if( $k == 'killsec_permax' ){
    echo '<div class="form-group">
    		<label for="" class="col-sm-2 control-label">最多售出数量</label>
    		<div class="col-sm-8" style="line-height:35px;height:35px;" id="max_notice">【最多售出数量】= 【购买人数】* 【限购数量】</div>
    	</div>';
}

if( $k == 'start_time' ){
    if($model->m_get('schedule_type')==$model::SCHEDULE_TYPE_FIX){
        $schedule_type_fix= 'checked="checked"';
        $schedule_type_cyc= '';
        $schedule_type_list= 'style="display:none"';
        $killsec_time= $model->m_get('killsec_time');
    
    } else {
        $schedule_type_fix= '';
        $schedule_type_cyc= 'checked="checked"';
        $schedule_type_list= '';
        $killsec_time= substr($model->m_get('killsec_time'), 11);
    }
    
    $schedule_html= '';
    $schedule= explode(',', $model->m_get('schedule'));
    $week_arr= array( 1=>'一', 2=>'二', 3=>'三', 4=>'四', 5=>'五', 6=>'六', 7=>'日', );
    for($i=1; $i<=7; $i++){
        $schedule_html.= "<label class='col-sm-2' ><input type='checkbox' name='schedule[]' value='{$i}' ";
        if(in_array($i, $schedule)) $schedule_html.= " checked='checked' ";
        $schedule_html.= "> 周{$week_arr[$i]} </label>";
    }
    
    echo '<div class="form-group">
    		<label for="" class="col-sm-2 control-label">活动模式</label>
    		<div class="col-sm-8">
<label class="col-sm-5" ><input type="radio" name="schedule_type" '. $schedule_type_fix. ' value="'. $model::SCHEDULE_TYPE_FIX .'" required ><abbr title=""> 按日期 </abbr></label>
<label class="col-sm-5" ><input type="radio" name="schedule_type" '. $schedule_type_cyc. ' value="'. $model::SCHEDULE_TYPE_CYC .'" required ><abbr title=""> 按星期 </abbr></label>
    		</div>
    	</div>';
    echo '<div class="form-group" id="schedule_sel_list" '. $schedule_type_list. '>
    		<label for="" class="col-sm-2 control-label">选择星期</label>
    		<div class="col-sm-8">'. $schedule_html. '</div>
    	</div>';
    echo '<div class="form-group">
            <label for="el_killsec_time" class="col-sm-2 control-label">秒杀启动时间</label>
            <div class="col-sm-8" >
    		    <div class=" input-group date">
                    <input value="'. $killsec_time. '" type="text" id="el_killsec_time" required placeholder="请先选择活动模式" class="form-control" name="killsec_time" size="16">
                    <span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
            	</div>
            </div>
        </div>';
    echo '<div class="form-group">
		<label for="el_act_type" class="col-sm-2 control-label">持续时间</label>
    		<div class="col-sm-8">
                <input value="" type="number" id="el_end_time" required placeholder="请输入1~72的整数" class="form-control" name="end_time" min=1 max=72 step=1>
                <!--
    			<select class="form-control selectpicker show-tick" data-live-search="true" name="end_time" required >
    				<option value=""> -请选择- </option>
    				<option value="1"> 1小时 </option>
    				<option value="3"> 3小时 </option>
    				<option value="6"> 6小时 </option>
    				<option value="9"> 9小时 </option>
    				<option value="23"> 23小时 </option>
    			</select>
                -->
    		</div>
    	</div>';
}
                ?>
			<?php endforeach; ?>
<!-- 
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<div class="checkbox">
						<label>
							<input type="checkbox" /> 选项
						</label>
					</div>
				</div>
			</div>
 -->
		</div>
		<!-- /.box-body -->
		<div class="box-footer ">
            <div class="col-sm-4 col-sm-offset-4">
                <button type="reset" class="btn btn-default">清除</button>
                <button type="submit" class="btn btn-info pull-right">保存</button>
            </div>
		</div>
		<!-- /.box-footer -->
	<?php echo form_close() ?>
</div>
<!-- /.box -->

        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->

<?php 
/* Footer Block @see footer.php */
require_once VIEWPATH. $tpl .DS .'privilege'. DS. 'footer.php';
?>
<?php 
/* Right Block @see right.php */
require_once VIEWPATH. $tpl .DS .'privilege'. DS. 'right.php';
?>
</div><!-- ./wrapper -->
<?php 
/* Right Block @see right.php */
require_once VIEWPATH. $tpl .DS .'privilege'. DS. 'commonjs.php';
?>
<script>

$(function() {
    <?php if($model->m_get('schedule_type') == $model::SCHEDULE_TYPE_FIX): ?>
        $('#el_end_time').attr("placeholder","请输入1~72之间的整数");
        $('#el_end_time').attr("max","72");
    <?php else: ?>
        $('#el_end_time').attr("placeholder","请输入1~23之间的整数");
        $('#el_end_time').attr("max","23");
    <?php endif; ?>
});

	//添加一个js选了拼图跳到拼团添加，选了秒杀跳到秒杀添加。
	//编辑进来的要disable,不能选择活动类型了
	var id_is_true = "<?php echo $model->m_get($pk); ?>";
	if( id_is_true ){
		$("#el_act_type").attr('disabled','disabled');
	}

	$("input[name=schedule_type]").click(function(){
	    var sel_v= $(this).val();
	    if(sel_v=='1'){
	    	$("#el_killsec_time").val('');
	    	$("#el_killsec_time").datetimepicker({
	    	    format:'yyyy-mm-dd hh:ii:ss', language: "zh-CN", clearBtn: false,todayBtn: false,orientation: "auto left"
	    	});
		    $('#schedule_sel_list').stop().hide();
            $('#el_end_time').attr("placeholder","请输入1~72之间的整数");
            $('#el_end_time').attr("max","72");
	    } else {
	    	$("#el_killsec_time").val('');
	    	$("#el_killsec_time").datetimepicker({
	    	    format:'hh:ii:ss', language: "zh-CN", clearBtn: false,todayBtn: false,orientation: "auto left"
	    	});
		    $('#schedule_sel_list').stop().show();
            $('#el_end_time').attr("placeholder","请输入1~23之间的整数");
            $('#el_end_time').attr("max","23");
	    }
	})


	
	$("#el_act_type").change(function(){
		var act_type = $(this).val();
		var killsec = "<?php echo $ActivityModel::ACT_TYPE_KILLSEC; ?>";
		var groupon = "<?php echo $ActivityModel::ACT_TYPE_GROUPON; ?>";
		var url = '';
		if( act_type == killsec ){
			url = "<?php echo Soma_const_url::inst()->get_url('*/activity_killsec/add'); ?>";
		}else if( act_type == groupon ){
			url = "<?php echo Soma_const_url::inst()->get_url('*/activity_package/add'); ?>";
		}
		window.location.href=url;
	});

	$("#el_product_id").change(function(){
		alert('请保障该商品在活动时间内处于正常销售状态！');
	});

	function max_notice(){
		if( $("#el_killsec_count").val()>0 &&  $("#el_killsec_permax").val()>0 ){
			var message= '请保障该活动商品的库存数量  <b> 大于'+ $("#el_killsec_count").val()* $("#el_killsec_permax").val() + '</b>';
			//alert(message);
			$('#max_notice').addClass('alert-danger');
			$('#max_notice').html(message);
		}
	}
	$("#el_killsec_count").change(function(){
		max_notice();
	});
	$("#el_killsec_permax").change(function(){
		max_notice();
	});
	$("#el_killsec_count").blur(function(){
		max_notice();
	});
	$("#el_killsec_permax").blur(function(){
		max_notice();
	});

	$("#el_end_time").blur(function(){
        return;
	    var killsec_time= $("#el_killsec_time").val();
        var end_time = $("#el_end_time").val();

        var killStartTime=new Date(killsec_time);
        var endTIme=new Date(end_time);
        console.log(end_time);
        console.log(endTIme);
        var s_time=endTIme-killStartTime;

        if(false && s_time<=0){
            alert('秒杀结束时间不能早过'+ killsec_time );
        }else if(s_time > 24*60*60*1000){
            var deadLineStr = killStartTime.valueOf() +  24*60*60*1000;
            var deadLine = new Date(deadLineStr);

            var month = parseInt(deadLine.getMonth()) + 1;
            var dateDay = parseInt(deadLine.getDate());
            if(month <= 10){
                month = "0" + month;
            }
            if(dateDay<=10){
                dateDay = "0" + dateDay;
            }
            deadLineF = deadLine.getFullYear() +"-"+ month + "-" + dateDay + " ";
            var hour = parseInt((deadLineStr/1000)%86400/3600);
            var minute = parseInt((deadLineStr/1000)%3600/60);
            var second = parseInt((deadLineStr/1000)%60);
            if(hour <= 10){
                hour = '0'+hour;
            }
            if(minute <= 10){
                minute = '0'+minute;
            }
            if(second <= 10){
                second = '0'+second;
            }
            deadLineF = deadLineF + hour + ":" + minute + ":" + second;
            $("#el_end_time").val(deadLineF);
            alert('秒杀结束时间不能迟于'+ deadLineF );
        }

//	    if(true){
//		    var dealline= '1111-11-11 11:11:11';
//	    	$("#el_end_time").val(dealline);
//	        alert('秒杀结束时间不能迟于'+ dealline );
//	    }
	});


</script>
</body>
</html>
