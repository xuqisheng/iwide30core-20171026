<!-- DataTables -->
<link rel="stylesheet"
      href="<?php echo base_url(FD_PUBLIC) . '/' . $tpl ?>/plugins/datatables/dataTables.bootstrap.css">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="<?php echo base_url(FD_PUBLIC) ?>/js/html5shiv.min.js"></script>
<script src="<?php echo base_url(FD_PUBLIC) ?>/js/respond.min.js"></script>
<![endif]-->

<style>
    .selected{
        background: #ccc !important;
    }
</style>
</head>
<?php //exit(json_encode($js_filter, JSON_UNESCAPED_UNICODE)) ?>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

    <?php
    /* 顶部导航 */
    echo $block_top;
    ?>

    <?php
    /* 左栏菜单 */
    echo $block_left;
    ?>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1><?php echo $breadcrumb_array['action']; ?>
                <small></small>
            </h1>
            <ol class="breadcrumb"><?php echo $breadcrumb_html; ?></ol>
        </section>


        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-body">
                            <div id="data-grid_wrapper" class="dataTables_wrapper form-inline dt-bootstrap">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="dataTables_length" id="data-grid_length"><label>每页显示</label> <select
                                                        name="data-grid_length" aria-controls="data-grid"
                                                        class="form-control input-sm">
                                                    <?php foreach ([20, 50, 100, 200] as $val):?>
                                                        <option value="<?= $val ?>" <?= $val == (isset($_REQUEST['page_size']) ? $_REQUEST['page_size'] : null) ? 'selected' : '' ?> ><?= $val ?></option>
                                                    <?php endforeach;?>
                                                </select> 条记录&nbsp;&nbsp;&nbsp;
                                                <div class="btn-group">
                                                        <button type="button" class="btn btn-sm bg-green" id="grid-btn-add">
                                                            <i class="fa fa-plus"></i>&nbsp;新增
                                                        </button>
                                                        <button type="button" class="btn btn-sm disabled" id="grid-btn-edit">
                                                            <i class="fa fa-edit"></i>&nbsp;编辑
                                                        </button>
                                                    &nbsp;&nbsp;
                                                    <?= $js_filter_btn ?>
                                                    &nbsp;&nbsp;
                                                    <?= $js_status_btn ?>
                                        </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div id="data-grid_filter" class="dataTables_filter"><label>搜索<input
                                                        type="search" class="form-control input-sm" placeholder=""
                                                        aria-controls="data-grid" name="name" value="<?= $js_word ?>"></label>
                                            <button type="button" class="btn btn-sm" id="grid-btn-search"><i class="fa fa-search"></i>&nbsp;搜索</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-12">
                                        <table id="data-grid"
                                               class="table table-bordered table-striped table-condensed dataTable"
                                               role="grid" aria-describedby="data-grid_info">
                                            <thead>
                                            <tr role="row">
                                                <th width="6%" class="sorting_desc_" tabindex="0"
                                                    aria-controls="data-grid" rowspan="1" colspan="1"
                                                    aria-label="编号: activate to sort column ascending"
                                                    aria-sort="descending">编号
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="商品分类: activate to sort column ascending">商品分类
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="产品类型: activate to sort column ascending">产品类型
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="商品类型: activate to sort column ascending">商品类型
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="商品名: activate to sort column ascending">商品名
                                                </th>
                                                <th width="8%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="库存量: activate to sort column ascending">库存量
                                                </th>
                                                <th width="6%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="微信价: activate to sort column ascending">微信价
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="封面图: activate to sort column ascending">封面图
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="透明封面图: activate to sort column ascending">透明封面图
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="首页是否显示: activate to sort column ascending">首页是否显示
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="能否退款: activate to sort column ascending">能否退款
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="能否邮寄: activate to sort column ascending">能否邮寄
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="能否赠送: activate to sort column ascending">能否赠送
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="到店自提/到店用券: activate to sort column ascending">到店自提/到店用券
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="是否需要预约: activate to sort column ascending">是否需要预约
                                                </th>
                                                <th width="5%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="是否显示销售数量: activate to sort column ascending">是否显示销售数量
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="排序: activate to sort column ascending">排序
                                                </th>
                                                <th width="10%" class="sorting_" tabindex="0" aria-controls="data-grid"
                                                    rowspan="1" colspan="1"
                                                    aria-label="状态: activate to sort column ascending">状态
                                                </th>
                                            </tr>
                                            </thead>

                                           <tfoot>
                                            <tr>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p1'] ?>"
                                                            type="text" placeholder="编号" size="8" onchange="category('p1', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p2'] ?>"
                                                            type="text" placeholder="商品分类" size="8" onchange="category('p2', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p3'] ?>"
                                                            type="text" placeholder="产品类型" size="8" onchange="category('p3', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p4'] ?>"
                                                            type="text" placeholder="商品类型" size="8" onchange="category('p4', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p5'] ?>"
                                                            type="text" placeholder="商品名" size="8" onchange="category('p5', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p6'] ?>"
                                                            type="text" placeholder="库存量" size="8" onchange="category('p6', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p7'] ?>"
                                                            type="text" placeholder="微信价" size="8" onchange="category('p7', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p8'] ?>"
                                                            type="text" placeholder="封面图" size="8" onchange="category('p8', $(this).val())" disabled></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p9'] ?>"
                                                            type="text" placeholder="透明封面图" size="8" onchange="category('p9', $(this).val())" disabled></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p10'] ?>"
                                                            type="text" placeholder="首页是否显示" size="8" onchange="category ('p10', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p11'] ?>"
                                                            type="text" placeholder="能否退款" size="8" onchange="category('p11', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p12'] ?>"
                                                            type="text" placeholder="能否邮寄" size="8" onchange="category('p12', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p13'] ?>"
                                                            type="text" placeholder="能否赠送" size="8" onchange="category('p13', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p14'] ?>"
                                                            type="text" placeholder="到店自提/到店用券" size="8" onchange="category('p14', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p15'] ?>"
                                                            type="text" placeholder="是否需要预约" size="8" onchange="category('p15', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p16'] ?>"
                                                            type="text" placeholder="是否显示销售数量" size="8" onchange="category('p16', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p17'] ?>"
                                                            type="text" placeholder="排序" size="8" onchange="category('p17', $(this).val())"></th>
                                                <th style="text-align:center;" rowspan="1" colspan="1"><input value="<?= $bottom_filters['p18'] ?>"
                                                            type="text" placeholder="状态" size="8" onchange="category('p18', $(this).val())"></th>
                                            </tr>
                                            </tfoot>

                                            <tbody>
                                            <?php if(isset($result['data']) && count($result['data'])):?>
                                                <?php foreach ($result['data'] as $key => $val):?>
                                                    <?php unset($val['DT_RowId']);?>
                                                    <tr id=<?= $val[0] ?> role="row" class="odd">
                                                        <?php foreach ($val as $item => $vale):?>
                                                            <td><?= $vale ?></td>
                                                        <?php endforeach;?>
                                                    </tr>
                                                <?php endforeach;?>
                                            <?php endif;?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="row">
                                    <?php
                                       //当前页码
                                       $currentPage = $result['page_num'];
                                       //总页码
                                       $totalPage = ceil($result['total'] / $result['page_size']);
                                       //总记录数
                                       $total = $result['total'];
                                       //每页记录数
                                       $eachCount = $result['page_size'];
                                       //开始记录数
                                       $startCount = ($currentPage - 1) * $eachCount + 1;
                                       //结束记录数
                                       $endCount = $startCount + count($result['data']) - 1;
                                       //显示页码
                                       $interval = 3;
                                       $previousPage = $currentPage - 1 <= 0 ? 1 : $currentPage - 1;
                                       $nextPage = $currentPage + 1 >= $totalPage ? $totalPage : $currentPage + 1;
                                       $left = $currentPage - $interval <= 0 ? 1 : $currentPage - $interval;
                                       $right = $currentPage + $interval >= $totalPage ? $totalPage : $currentPage + $interval;


                                       //分页链接
                                       $currentUrl = $_SERVER['REQUEST_URI'];
                                       if(strpos($currentUrl, "page_num=") === false) {
                                            if(strpos($currentUrl, "?") === false){
                                                $currentUrl .= '?page_num=%d';
                                            }
                                            else{
                                                $currentUrl .= '&page_num=%d';
                                            }
                                       }
                                       else {
                                           $currentUrl = preg_replace('/page_num=\d/', 'page_num=%d', $currentUrl);
                                       }

                                       $currentUrl = urldecode($currentUrl);
                                    ?>
                                    <div class="col-sm-5">
                                        <div class="dataTables_info" id="data-grid_info" role="status"
                                             aria-live="polite">
                                            当前显示第<?= $currentPage ?> / <?= $totalPage ?>页，
                                            记录从 <?= $startCount ?> 到 <?= $endCount ?> ，共 <?= $total ?> 条
                                        </div>
                                    </div>
                                    <?php if($result['total']):?>
                                        <div class="col-sm-7">
                                            <div class="dataTables_paginate paging_simple_numbers" id="data-grid_paginate">
                                                <ul class="pagination">
                                                    <li class="paginate_button previous" id="data-grid_previous"><a href="<?= sprintf($currentUrl, $previousPage) ?>">上一页</a></li>
                                                    <?php for($i = $left; $i <= $right; $i++):?>
                                                        <li class="paginate_button <?= $i == $currentPage ? 'active' : '' ?>"><a href="<?= sprintf($currentUrl, $i) ?>"><?= $i ?></a></li>
                                                    <?php endfor;?>
                                                    <li class="paginate_button next" id="data-grid_next"><a href="<?= sprintf($currentUrl, $nextPage) ?>">下一页</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    <?php endif;?>
                                </div>

                            </div>
                        </div><!-- /.box-body -->
                    </div><!-- /.box -->
                </div><!-- /.col -->
            </div><!-- /.row -->
        </section>


    </div><!-- /.content-wrapper -->

    <?php
    /* Footer Block @see footer.php */
    require_once VIEWPATH . $tpl . DS . 'privilege' . DS . 'footer.php';
    ?>

    <?php
    /* Right Block @see right.php */
    require_once VIEWPATH . $tpl . DS . 'privilege' . DS . 'right.php';
    ?>

</div><!-- ./wrapper -->

<?php
/* Right Block @see right.php */
require_once VIEWPATH . $tpl . DS . 'privilege' . DS . 'commonjs.php';
?>

<script src="<?php echo base_url(FD_PUBLIC) . '/' . $tpl ?>/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="<?php echo base_url(FD_PUBLIC) . '/' . $tpl ?>/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="<?php echo base_url(FD_PUBLIC) . '/' . $tpl ?>/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- page script -->
<script>
    <?php
    $sort_index = $model->field_index_in_grid($default_sort['field']);
    $sort_direct = $default_sort['sort'];

    $buttions = '';    //button之间不能有字符空格，用php组装输出
    $buttions .= '<button type="button" class="btn btn-sm bg-green" id="grid-btn-add"><i class="fa fa-plus"></i>&nbsp;新增</button>';
    $buttions .= '<button type="button" class="btn btn-sm disabled" id="grid-btn-edit"><i class="fa fa-edit"></i>&nbsp;编辑</button>';
    //$buttions.= '<button type="button" class="btn btn-sm disabled" id="grid-btn-del"><i class="fa fa-trash"></i>&nbsp;删除</button>';
    $buttions .= $js_filter_btn;
    $buttions .= $js_status_btn;

    ?>

    <?php echo $js_filter; ?>

    var count = 0, id = null;

    size();
    search();
    addSoma();
    editSoma();
    selectSoma();

    //select
    function selectSoma() {
        $('.odd').off().on('click', function () {
            if($(this).hasClass('selected')){
                $(this).removeClass('selected');
            }
            else{
                $(this).addClass('selected');
            }

            count = 0;
            $('.odd').each(function () {
                if($(this).hasClass('selected')){
                    count += 1;
                    id = $(this).attr('id');
                }
            });
            if(count == 1 && id){
                $('#grid-btn-edit').removeClass('disabled').addClass('bg-green');
            }
            else{
                $('#grid-btn-edit').addClass('disabled').removeClass('bg-green');
            }
        });
    }

    //edit
    function editSoma() {
        $('#grid-btn-edit').on('click', function () {
            if($(this).hasClass('disabled') === false){
                window.location.href = "<?= Soma_const_url::inst()->get_url('*/*/edit') ?>" + "?ids=" + id;
            }
        });
    }

    //add
    function addSoma() {
        $('#grid-btn-add').on('click', function () {
            window.location.href = "<?= Soma_const_url::inst()->get_url('*/*/add') ?>";
        });
    }

    //select the count of each page to show
    function size() {
        $('select[name="data-grid_length"]').on('change', function () {
            window.location.href = url('page_size', $(this).val());
        })
    }

    //search goods with title
    function search() {
        $('#grid-btn-search').off().on('click', function () {
            window.location.href = url('like[name]', $('input[name="name"]').val());
        });
    }

    //search goods with columns
    function category(cat, val) {
        window.location.href = url(cat, val);
    }


    //update the params of url
    function url(key, val) {
        var split = '?', url = window.location.href, flag = key;
        if(url.indexOf('?') != -1){
            split = '&';
        }
        if(val == '-'){
            val = '';
        }
        if(url.indexOf(flag) != -1){
            var _previous = url.split('?')[0];
            var _after = url.split('?')[1];
            var _afterNew = '';
            //填充新参数
            var _all = _after.split('&');
            if(_all.length){
                for(var i = 0; i < _all.length; i++){
                    //参数
                    if(_all[i].indexOf(flag) != -1){
                        _all[i] = _all[i].replace(_all[i], flag + '=' + val);
                    }
                    _afterNew += ('&' + _all[i]);
                }
                _afterNew = _afterNew.substr(1, _afterNew.length);
            }
            return _previous + '?' + _afterNew;
        }
        else{
            return url.split(split)[0] + split + flag + '='+  val;
        }
    }


</script>
</body>
</html>
